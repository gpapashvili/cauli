{% extends 'base.html' %}

{% block content %}
{% load custom_tags %}

<div class="container mt-4">
    {% if transaction_identifier == 'ინფორმაცია' %}
        <h2>ინფორმაცია <a href="{% url 'lot_update' form.lot_id.value %}?next={{ request.path|urlencode }}" class="btn btn-secondary">{{ form.lot_id.value }} პარტიაზე</a></h2>
    {% elif action == 'დამატება' %}
        <h2>ახალი {{ transaction_identifier|slice:":-1" }}ის {{ action }} {% if form.lot_id.value %}<a href="{% url 'lot_update' form.lot_id.value %}?next={{ request.path|urlencode }}" class="btn btn-secondary">{{ form.lot_id.value }} პარტიაზე</a>{% endif %}</h2>
    {% else %}
        <h2>{{ addtransactionform.model_id.value }} ტრანზაქციაზე ინფორმაციის {{ action }} </h2>
    {% endif %}

    {% if transaction_identifier != 'ინფორმაცია' %}
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}

            <div class="mb-2 d-flex gap-2">
                <div class="mb-3 text-center">
                    <div class="mb-2">
                        <img src="/media/{% if form.image_location.value  %}{{ form.image_location.value }}{% else %}no_image.jpg{% endif %}" alt="უსურათო" width="200" height="200">
                    </div>
                    <div class="mb-2">
                        <button type="submit" class="btn btn-primary">{{ action }}</button>
                        <a href="{{ next_url }}?next={{ request.path|urlencode }}" class="btn btn-secondary">უკან</a>
                    </div>
                    {% if transaction_identifier == "ჩამოსხმა" or transaction_identifier == "დამუშავება" and form.lot_id.value %}
                        <div class="mb-2">
                            <a href="{% url 'transaction_create' 'მეტალის_აღება' form.lot_id.value  %}?next={{ request.path|urlencode }}" class="btn btn-outline-warning">მეტალის აღება</a>
                        </div>
                        <div class="mb-2">
                            <a href="{% url 'transaction_create' 'მეტალის_დაბრუნება' form.lot_id.value %}?next={{ request.path|urlencode }}" class="btn btn-outline-secondary">ნარჩენის დაბრუნება</a>
                        </div>
                        <div class="mb-2">
                            <a href="{% url 'transaction_create' 'მეტალის_დანაკარგი' form.lot_id.value  %}?next={{ request.path|urlencode }}" class="btn btn-outline-danger">დანაკარგი</a>
                        </div>
                        <div class="mb-2">
                            <a href="{% url 'transaction_create' 'ხელფასი' form.lot_id.value  %}?next={{ request.path|urlencode }}" class="btn btn-outline-info">ხელფასის გადახდა</a>
                        </div>
                    {% elif transaction_identifier == "გადაყვანა" %}
                        <div class="mb-2">
                            <a href="{% url 'transaction_create' 'მეტალის_აღება' 0 %}?next=/transaction_list/გადაყვანა/transaction_type/" class="btn btn-outline-warning">მეტალის აღება</a>
                        </div>
                        <div class="mb-2">
                            <a href="{% url 'transaction_create' 'მეტალის_დაბრუნება' 0 %}?next=/transaction_list/გადაყვანა/transaction_type/" class="btn btn-outline-secondary">მეტალის დაბრუნება</a>
                        </div>
                    {% endif %}
                </div>
                <div class="mb-1">
                    {% for field in form %}
                        <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                        {{ field }}
                    {% endfor %}
                </div>
                <div class="mb-1">
                    {% if transaction_identifier == 'გადაყვანა' or transaction_identifier == 'მეტალის_დაბრუნება'  %}
                        <p>არსებული სინჯებიდან გადადნობით ვიღებთ ახალ სინჯს</p>
                        <p>ორი ტიპის გატარება არის</p>
                        <ol>
                         <li>ვიღებთ გადასაყვანად მეტალს
                            <ul>
                                <li>რაოდენობას ვატარებთ მინუსით</li>
                                <li>აკლდება შესაბამის მეტალს</li>
                            </ul>
                         </li>
                         <li>ვაბრუნებთ გადაყვანილ მეტალს
                            <ul>
                                <li>რაოდენობას ვატარებთ პლიუსით</li>
                                <li>ემატება შესაბამის მეტალს</li>
                                <li>ფასის გამოსათვლელად გამოიყენე შემდეგი კალკულატორი</li>
                                <li>
                                    <div class="mb-1 d-flex">
                                        <font color="red">სულ აღებული მეტალის ფასი</font>
                                        <input type="number" class="form-control" value="{{ summary_tables.0.გადაყვანები.1.total_cost_in }}" id="total_cost" name="" oninput="calculateSum()">
                                    </div>
                                </li>
                                <li>
                                    <div class="mb-2 d-flex gap-2">
                                        <font color="red">მიღებული მეტალის წონა</font>
                                        <input type="number" class="form-control" value={{ summary_tables.0.გადაყვანები.1.total_weight_in }} id="weight" name="" oninput="calculateSum()">
                                    </div>
                                </li>
                                <li>
                                    <div class="mb-2 d-flex gap-2">
                                        <font color="red">ფასის დაანგარიშება</font>
                                        <input type="number" class="form-control" value={{ summary_tables.0.გადაყვანები.1.total_cost_in|dividerem2:summary_tables.0.გადაყვანები.1.total_weight_in }} id="price" name="" oninput="calculateSum()">
                                    </div>
                                </li>
                                <script>
                                    function calculateSum() {
                                        const total_cost = parseFloat(document.getElementById('total_cost').value) || 0;
                                        const weight = parseFloat(document.getElementById('weight').value) || 0;
                                        document.getElementById('price').value = (total_cost / weight).toFixed(2)
                                    }
                                </script>
                            </ul>
                         </li>
                        </ol>
                    {% elif  transaction_identifier == 'ჩამოსხმა'  %}
                        <p>საიუველირო ნაწარმის ჩამოსხმა</p>
                        <p>ოთხი ტიპის გატარება არის</p>
                        <ol>
                         <li>ვიღებთ ჩამოსხმისთვის მეტალს
                            <ul>
                                <li>რაოდენობას ვატარებთ მინუსით</li>
                                <li>აკლდება შესაბამის მეტალს</li>
                            </ul>
                         </li>
                         <li>ვაბრუნებთ მეტალს (ჯართს)
                            <ul>
                                <li>რაოდენობას ვატარებთ პლიუსით</li>
                                <li>ემატება შესაბამის მეტალს</li>
                            </ul>
                         </li>
                         <li>გადაყვანის დანაკარგის გატარება
                            <ul>
                                 <li>მასალაში ვუთითებთ "ოქრო-585 დანაკარგი"</li>
                                 <li>მეტალის რაოდენობა არ იცვლება</li>
                                 <li>რაოდენობას ვატარებთ პლიუსით</li>
                            </ul>
                         </li>
                         <li>ჩამოსხმის მომსახურების გადახდა
                            <ul>
                                 <li>მასალაში ვუთითებთ ფულს</li>
                                 <li>რაოდენობაში ვუთითებთ ჩამოსხმის წონას მინუსით</li>
                                 <li>ფასში გრამზე გადასახადს</li>
                                 <li>სულ დაიანგარიშებს ფასს და გამოაკლდება ფულს</li>
                            </ul>
                         </li>
                        </ol>
                    {% elif  transaction_identifier == 'დამუშავება'  %}
                        <p>საიუველირო ნაწარმის დამუშავება</p>
                        <p>ოთხი ტიპის გატარება არის</p>
                        <ol>
                         <li>ვიღებთ დამუშავებისთვის მეტალს (პრიპოი, მავთული)
                            <ul>
                                <li>რაოდენობას ვატარებთ მინუსით</li>
                                <li>აკლდება შესაბამის მეტალს</li>
                            </ul>
                         </li>
                         <li>ხელოსანი აბრუნებს ნარჩენებს
                            <ul>
                                <li>რაოდენობას ვატარებთ პლიუსით</li>
                                <li>ემატება შესაბამის მეტალს</li>
                            </ul>
                         </li>
                         <li>დამუშავების დანაკარგის გატარება
                            <ul>
                                 <li>მასალაში ვუთითებთ "ოქრო-585 დანაკარგი"</li>
                                 <li>მეტალის რაოდენობა არ იცვლება</li>
                                 <li>რაოდენობას ვატარებთ პლიუსით</li>
                            </ul>
                         </li>
                         <li>დამუშავების მომსახურების გადახდა
                            <ul>
                                 <li>მასალაში ვუთითებთ ფულს</li>
                                 <li>რაოდენობაში ვუთითებთ ჩამოსხმის წონას მინუსით</li>
                                 <li>ფასში გრამზე გადასახადს</li>
                                 <li>სულ დაიანგარიშებს ფასს და გამოაკლდება ფულს</li>
                            </ul>
                         </li>
                        </ol>
                    {% else %}
                {#                    TODO: Add some instructions#}
                        <p style="text-align: center">სხვადასხვა დამხმარე ხელსაწყოები</p>
                        <ul>
                         <li>
                            <div class="mb-2 d-flex">
                                სულ ფასი
                                <input type="number" class="form-control" id="total_cost" name="" step="0.01" oninput="calculateTotalCost()">
                            </div>
                        </li>
                        <li>
                            <div class="mb-2 d-flex">
                                ცალის ფასი
                                <input type="number" class="form-control" id="piece_price" name="" step="0.01" oninput="calculatePiecePrice()">
                            </div>
                        </li>
                        <script>
                            function calculateTotalCost() {
                                const transaction_quantity = parseFloat(document.getElementById('transaction_quantity').value) || 0;
                                const cost_unit = parseFloat(document.getElementById('cost_unit').value) || 0;
                                document.getElementById('total_cost').value = (transaction_quantity * cost_unit).toFixed(2)
                            }
                            function calculatePiecePrice() {
                                const total_cost = parseFloat(document.getElementById('total_cost').value) || 0;
                                const pieces = parseFloat(document.getElementById('pieces').value) || 0;
                                document.getElementById('piece_price').value = (total_cost / pieces).toFixed(2)
                            }
                        </script>
                        </ul>
                    {% endif %}
                </div>
            </div>
        </form>
    {% endif %}
    <br>
    {% if form.lot_id.value or transaction_identifier == 'გადაყვანა' %}
        {% for header, table in transactions_table.items %}
            <center><h3>{{ header }}</h3></center>
            <hr style="height:2px;border-width:0;color:red;background-color:red">
            <table class="table table-striped table-hover table-sm">
                <tbody>
                    {% for transaction in table  %}
                        <tr>
                            {% if transaction.tmstmp == 'თარიღი' %}
                                {% for data in transaction %}
                                    <td>{{ data }}</td>
                                {% endfor %}
                            {% else %}
                                <td>{{ transaction.lot_id|floatformat:0 }}</td>
                                <td>{% if transaction.description != None %}{{ transaction.description|slice:"28" }}{% endif %}</td>
                                <td>{{ transaction.tmstmp|slice:"8" }}</td>
                                <td>{{ transaction.transaction_type }}</td>
                                <td><a href="{% url 'transaction_update' transaction.tmstmp transaction.item %}?next={{ request.path|urlencode }}" class="btn btn-sm btn-primary">{{ transaction.item }}</a></td>
                                <td>{{ transaction.item_type }}</td>
                                <td>{{ transaction.transaction_quantity }}</td>
                                <td>{{ transaction.cost_unit|floatformat:2 }}</td>
                                <td>{{ transaction.total_cost|floatformat:2 }}</td>
                                <td><a href="{% url 'transaction_delete' transaction.tmstmp transaction.item %}?next={{ request.path|urlencode }}" class="btn btn-sm btn-danger">წ</a></td>
                            {% endif %}
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% endfor %}
    {% endif %}

    <div class="mb-3 d-flex gap-3">
        {% for header_table in materials_tables %}
            <div class="mb-2">
                {% for header, table in header_table.items %}
                <center><h3>{{ header }}</h3></center>
                <hr style="height:2px;border-width:0;color:red;background-color:red">
                    <table class="table table-striped table-hover table-sm">
                        <tbody>
                            {% for row in table  %}
                                <tr>
                                    {% for item in row %}
                                        <td>{{ item }}</td>
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% endfor %}
            </div>
        {% endfor %}
    </div>

    {% if transaction_identifier != 'ნებისმიერი' %}
        <div class="mb-2">
            {% for header_table in summary_tables %}
                <div class="mb-2">
                    {% for header, table in header_table.items %}
                    <center><h3>{{ header }}</h3></center>
                    <hr style="height:2px;border-width:0;color:red;background-color:red">
                        <table class="table table-striped table-hover table-sm">
                            <tbody>
                                {% for row in table  %}
                                    <tr>
                                        {% for item in row %}
                                            {% if item|is_nan %}
                                                <td class="bg-danger">{{ item }}</td>
                                            {% elif item == 0 %}
                                                <td class="table-warning">{{ item }}</td>
                                            {% else %}
                                                <td>{{ item }}</td>
                                            {% endif %}
                                        {% endfor %}
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% endfor %}
                </div>
            {% endfor %}
        </div>
    {% endif %}
</div>
{% endblock %}