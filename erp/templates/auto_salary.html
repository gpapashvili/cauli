{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="mb-5  text-center">
    <h2>ხელფასების ავტომატური გატარება <span style="color: Red">{{ lot_id }}</span> პარტიაზე</h2>
    </div>
    <form method="post">
        {% csrf_token %}
        <div class="mb-4 d-flex gap-4">
            <div class="mb-3">
                <button type="submit" class="btn btn-danger">დიახ</button>
                <a href="{% url 'lot_update' lot_id %}" class="btn btn-secondary">არა</a>
            </div>
            <div class="mb-2">
                <ul>
                    <li>
                        <div class="mb-1 d-flex gap-1">
                            <div class="mb-1">
                                <div class="mb-1">
                                    <label class="form-label" for="apply_gold_lost">ნაქლიბის და დანაკარგის გატარება</label>
                                    <input type="checkbox" id="apply_gold_lost" name="apply_gold_lost" value="1" oninput="calculateLostGold()">
                                </div>
                                <div class="mb-1">
                                    <label class="form-label" for="total_weight_out">წაღებული ოქრო</label>
                                    <input type="number" class="form-control" id="total_weight_out" name="total_weight_out" value="{{ total_weight_out }}" step="0.01" oninput="calculateLostGold()">
                                </div>
                                <div class="mb-1">
                                    <label class="form-label" for="total_weight_in">მოტანილი ნაკეთობები</label>
                                    <input type="number" class="form-control" id="total_weight_in" name="total_weight_in" step="0.01" oninput="calculateLostGold()">
                                </div>
                                <div class="mb-1">
                                    <label class="form-label" for="remaining_gold">მოტანილი ნაქლიბი</label>
                                    <input type="number" class="form-control" id="remaining_gold" name="remaining_gold" step="0.01" oninput="calculateLostGold()">
                                </div>
                                <div class="mb-1">
                                    <label class="form-label" for="lost_gold">დანაკარგი</label>
                                    <input type="number" class="form-control" id="lost_gold" name="lost_gold" step="0.01" oninput="calculateLostGold()">
                                </div>
                                <script>
                                    function calculateLostGold() {
                                    const total_weight_out = parseFloat(document.getElementById('total_weight_out').value) || 0;
                                    const total_weight_in = parseFloat(document.getElementById('total_weight_in').value) || 0;
                                    const remaining_gold = parseFloat(document.getElementById('remaining_gold').value) || 0;
                                    const apply_gold_lost = document.getElementById('apply_gold_lost').checked;
                                    document.getElementById('lost_gold').value = Math.abs(total_weight_out - total_weight_in -remaining_gold).toFixed(2);
                                    document.getElementById('total_weight_out').required = apply_gold_lost;
                                    document.getElementById('total_weight_in').required = apply_gold_lost;
                                    document.getElementById('remaining_gold').required = apply_gold_lost;
                                    document.getElementById('lost_gold').required = apply_gold_lost;
                                    }
                                </script>
                            </div>
                        </div>
                    </li>
                    <li>
                        <label class="form-label" for="grinding">დამუშავება</label>
                        <input type="checkbox" id="grinding" name="salary_list" value="cost_grinding">
                         - გადასახდელია <span style="color: red">{{ salaries.cost_grinding }} ლარი</span>, ჩამოეჭრება ფულის ანგარიშს
                    </li>
                    <li>
                        <label class="form-label" for="manufacturing_stone">თვლის ჩასმა</label>
                        <input type="checkbox" id="manufacturing_stone" name="salary_list" value="cost_manufacturing_stone">
                         - გადასახდელია <span style="color: red">{{ salaries.cost_manufacturing_stone }} ლარი</span>, ჩამოეჭრება ფულის ანგარიშს
                    </li>
                    <li>
                        <label class="form-label" for="polishing">გაპრიალება</label>
                        <input type="checkbox" id="polishing" name="salary_list" value="cost_polishing">
                         - გადასახდელია <span style="color: red">{{ salaries.cost_polishing }} ლარი</span>, ჩამოეჭრება ფულის ანგარიშს
                    </li>
                    <li>
                        <label class="form-label" for="plating">როდირება</label>
                        <input type="checkbox" id="plating" name="salary_list" value="cost_plating">
                         - გადასახდელია <span style="color: red">{{ salaries.cost_plating }} ლარი</span>, ჩამოეჭრება ფულის ანგარიშს
                    </li>
                    <li>
                        <label class="form-label" for="sinji">სინჯი</label>
                        <input type="checkbox" id="sinji" name="salary_list" value="cost_sinji">
                         - გადასახდელია <span style="color: red">{{ salaries.cost_sinji }} ლარი</span>, ჩამოეჭრება ფულის ანგარიშს
                    </li>
                    <li>
                         სულ გადასახდელია <span style="color: red">{{ salaries.total_salary }} ლარი</span>
                    </li>
                </ul>
            </div>
        </div>
    </form>
    {% for  transactions_table in transactions_tables %}
        {% for header, table in transactions_table.items %}
            <div style="text-align: center;"><h3>{{ header }}</h3></div>
            <hr style="height:2px;border-width:0;color:red;background-color:red">
            <table class="table table-striped table-hover table-sm">
                <tbody>
                    {% for transaction in table  %}
                        <tr>
                            {% if transaction.tmstmp == 'თარიღი' %}
                                {% for data in transaction %}
                                    <td>{{ data }}</td>
                                {% endfor %}
                            {% else %}
                                <td>{{ transaction.lot_id|floatformat:0 }}</td>
                                <td>{% if transaction.description != None %}{{ transaction.description|slice:"28" }}{% endif %}</td>
                                <td>{{ transaction.tmstmp|slice:"8" }}</td>
                                <td>{{ transaction.transaction_type }}</td>
                                <td><a href="{% url 'transaction_update' transaction.tmstmp transaction.item %}?next={{ request.path|urlencode }}" class="btn btn-sm btn-primary">{{ transaction.item }}</a></td>
                                <td>{{ transaction.item_type }}</td>
                                <td>{{ transaction.transaction_quantity }}</td>
                                <td>{{ transaction.cost_unit|floatformat:2 }}</td>
                                <td>{{ transaction.total_cost|floatformat:2 }}</td>
                                <td><a href="{% url 'transaction_delete' transaction.tmstmp transaction.item %}?next={{ request.path|urlencode }}" class="btn btn-sm btn-danger">წ</a></td>
                            {% endif %}
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% endfor %}
    {% endfor %}
</div>

{% endblock %}